name: Run & Post
on:
  workflow_dispatch: {}

jobs:
  e2e:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    strategy:
      fail-fast: false
      matrix:
        api-level: [33, 34]
        arch: [x86_64]
        target: [google_apis]

    env:
      TWITCH_APK: ${{ vars.TWITCH_APK }}

    steps:
      - uses: actions/checkout@v4

      # âœ… HW accel for emulator
      - name: Enable KVM perms (hard)
        run: |
          if [ -e /dev/kvm ]; then
            sudo chgrp kvm /dev/kvm || true
            sudo chmod 0666 /dev/kvm || true
            ls -l /dev/kvm
            groups
          else
            echo "No /dev/kvm found on this runner"
            ls -la /dev | grep kvm || true
          fi

      # Java / Gradle
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Gradle (with cache)
        uses: gradle/actions/setup-gradle@v4

      - name: (Optional) Assemble your app artifacts
        run: ./gradlew --no-daemon tasks || true

      # Python toolchain
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python deps
        run: |
          pip install -r requirements.txt
          python -V
          pip list

      # Appium server
      - name: Setup Appium server
        run: |
          npm -g install appium@next appium-uiautomator2-driver
          appium driver install uiautomator2
          nohup appium --base-path / > appium.log 2>&1 &

      # ðŸ§© create a bash script (to avoid /bin/sh loop problems)
      - name: Create boot_and_test.sh
        shell: bash
        run: |
          cat > /tmp/boot_and_test.sh <<'BASH'
          #!/usr/bin/env bash
          set -euo pipefail

          red()  { echo -e "\033[31m$*\033[0m"; }
          info() { echo "[INFO] $*"; }

          download_app() {
            local url="$1" out="$2"
            info "Downloading: $url"
            curl -L --fail --retry 5 --retry-delay 2 -D /tmp/headers.txt -o "$out" "$url" || {
              red "Download failed. Response headers:"; cat /tmp/headers.txt || true; return 1; }
            ls -lh "$out" || true
            local sz; sz=$(wc -c <"$out" || echo 0)
            if [ "$sz" -lt 500000 ]; then
              red "Downloaded file is too small ($sz bytes) â€” likely HTML/redirect. Headers:"; cat /tmp/headers.txt || true
              return 1
            fi
            local typ; typ=$(file -b "$out" || true)
            echo "[DEBUG] file(1): $typ"
            case "$typ" in
              *Zip*|*Android*|*Dalvik*|*APK*|*Java*|*JAR*) ;; 
              *) red "Unexpected file type: $typ (likely not an APK/bundle)"; return 1 ;;
            esac
          }

          install_apk_or_bundle() {
            local path="$1"
            if unzip -l "$path" >/dev/null 2>&1; then
              if unzip -l "$path" | grep -q "base.apk"; then
                info "Detected bundle container (XAPK/APKM/APKS). Extractingâ€¦"
                rm -rf /tmp/apkparts && mkdir -p /tmp/apkparts
                unzip -o "$path" -d /tmp/apkparts >/dev/null
                shopt -s nullglob
                mapfile -t apks < <(find /tmp/apkparts -maxdepth 3 -type f -name '*.apk' | sort)
                if [ "${#apks[@]}" -eq 0 ]; then
                  red "No .apk files found inside the bundle"; return 1
                fi
                echo "[DEBUG] bundle parts:"; printf ' - %s\n' "${apks[@]}"
                # ABI check: emulator is x86/x86_64?
                if adb shell getprop ro.product.cpu.abi | grep -qi 'x86'; then
                  if ! printf '%s\n' "${apks[@]}" | grep -qi 'x86'; then
                    red "No x86/x86_64 split found, but emulator is x86_64. Use an x86_64 variant or run on arm64 emulator."
                    return 1
                  fi
                fi
                adb install-multiple -r "${apks[@]}"
              else
                info "Installing plain APKâ€¦"
                adb install -r "$path"
              fi
            else
              info "Installing as plain APK (non-zip reported by file) â€¦"
              adb install -r "$path"
            fi
          }

          echo "[BOOT] Reset ADB"
          adb kill-server || true
          adb start-server
          adb wait-for-device
          adb devices

          # ðŸ” ADDITIONAL 'device' STATUS CHECK CYCLE AFTER wait-for-device
          echo "[BOOT] Ensure ADB state == device (not offline)"
          for i in $(seq 1 120); do
            state="$(adb get-state 2>/dev/null || true)"
            if [[ "$state" == "device" ]]; then
              echo "[BOOT] ADB state is device"
              break
            fi
            echo "[BOOT] ADB state=$state; retry $i/120"
            sleep 2
          done

          echo "[BOOT] Wait for sys.boot_completed == 1"
          for i in $(seq 1 180); do
            boot="$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r' || true)"
            if [[ "$boot" == "1" ]]; then
              echo "[BOOT] sys.boot_completed=1"
              break
            fi
            echo "[BOOT] sys.boot_completed=$boot; retry $i/180"
            sleep 2
          done

          echo "[BOOT] Wake screen"
          adb shell input keyevent 82 || true

          # ---- Install Twitch if provided ----
          if [[ -n "${TWITCH_APK:-}" ]]; then
            info "TWITCH_APK=${TWITCH_APK}"
            if echo "${TWITCH_APK}" | grep -E "^https?://" >/dev/null; then
              download_app "${TWITCH_APK}" "/tmp/twitch.pkg"
              install_apk_or_bundle "/tmp/twitch.pkg"
            else
              install_apk_or_bundle "${TWITCH_APK}"
            fi
          fi

          echo "[CHECK] Verify Twitch package presence"
          if ! adb shell pm list packages | grep -q "tv.twitch.android.app"; then
            red "Twitch is not installed and TWITCH_APK is not a compatible package."
            exit 1
          fi

          echo "[TEST] Run pytest (with one retry)"
          pytest -q || pytest -q
          BASH
          chmod +x /tmp/boot_and_test.sh
          ls -l /tmp/boot_and_test.sh

        # Emulator and tests (run the script)
      - name: Run tests on Android emulator
        uses: ReactiveCircus/android-emulator-runner@v2
        with:
          api-level: ${{ matrix.api-level }}
          arch: ${{ matrix.arch }}
          target: ${{ matrix.target }}
          force-avd-creation: true
          emulator-boot-timeout: 1200
          emulator-options: >
            -no-snapshot
            -no-window
            -gpu swiftshader_indirect
            -noaudio
            -camera-back none
            -camera-front none
            -no-boot-anim
          disable-animations: true
          script: bash /tmp/boot_and_test.sh

      # Artifacts
      - name: Upload artifacts (Appium/pytest logs)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-appium-logs-api-${{ matrix.api-level }}
          path: |
            appium.log
            .pytest_cache
            **/pytest-*.xml
            **/reports/**
